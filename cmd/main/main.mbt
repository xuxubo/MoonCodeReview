///|
async fn main {
  println("ðŸš€ å¼€å§‹è¿›è¡Œä»£ç è¯„å®¡æµç¨‹...")
  let (code, output) = @process.collect_stdout("git", ["diff", "HEAD~1", "HEAD"])
  if code != 0 {
    println("ðŸš€ git æ£€å‡ºå¤±è´¥")
    return
  }
  let review = condeReview(output.text())
  guard review != "" else {
    println("è¯„å®¡å¤±è´¥")
    return
  }
  let content = @json.parse(review)
  .value("choices")
  .bind(_.item(0))
  .bind(_.value("message"))
  .bind(_.value("content"))
  .bind(_.as_string()) catch {
    (_ : @json.ParseError) => panic()
  }
  let url = "https://github.com/xuxubo/code-review.git"
  let token = "ghp_26Qh7hKuXlbud19OHv1m61qq" // âš ï¸ æ›¿æ¢ä¸ºå®žé™… Token
  let repo_dir = "repo"

  // å…‹éš†
  println("ðŸš€ Cloning repo...")
  let repo = git_clone(url, repo_dir)
  println("âœ… Cloned")
  let file_name = git_file_name()
  //æ—¥æœŸç›®å½•
  //   let date_folder = "repo/2025-10-17"
  //   let _ = mkdir_p(date_folder)

  //å†™æ–‡ä»¶
  let file_path = "repo/" + file_name + ".md"
  let _ = write_file(file_path, content.to_string())
  println("âœ… File written")

  // æ·»åŠ  + æäº¤ + æŽ¨é€
  let add_ok = git_add(repo, file_path)
  if add_ok == 0 {
    println("âœ… Added file")
    let commit_ok = git_commit(repo, "Add new review via MoonBit")
    if commit_ok == 0 {
      println("âœ… Committed")
      let push_ok = git_push(repo, "origin", token)
      if push_ok == 0 {
        println("âœ… Pushed to GitHub")
      } else {
        println("âŒ Push failed, code=\{push_ok}")
      }
    }
  } else {
    println("âŒ Add failed")
  }
  println("âœ… Repository freed")
  println("âœ¨ Done.")
}

///|

///|
async test "get gitdiff" {
  let (code, output) = @process.collect_stdout("git", ["diff", "HEAD~1", "HEAD"])
  inspect(code, content="0")
  inspect(output.text(), content="abcd")
}

///|
test "send message API" {
  @mio.run(fn() {
    match (try? @mio.get("https://api.github.com")) {
      Ok(response) => {
        println("Status: " + response.statusCode.to_string())
        println("Response: " + response.text())
      }
      Err(e) => println("Error: " + e.to_string())
    }
  })
}

///|
test {
  let s =
    #|{
    #|  "id": "233a1c55-5183-47f3-a09a-f982aae6567e",
    #|  "object": "chat.completion",
    #|  "created": 1760360061,
    #|  "model": "deepseek-chat",
    #|  "choices": [
    #|    {
    #|      "index": 0,
    #|      "message": {
    #|        "role": "assistant",
    #|        "content": "ä½ çš„å†…å®¹..."
    #|      }
    #|    }
    #|  ],
    #|  "usage": {
    #|    "prompt_tokens": 191,
    #|    "completion_tokens": 515,
    #|    "total_tokens": 706
    #|  },
    #|  "system_fingerprint": "fp_ffc7281d48_prod0820_fp8_kvcache"
    #|}
  let response = @json.parse(s)
    .value("choices")
    .bind(_.item(0))
    .bind(_.value("message"))
    .bind(_.value("content"))
    .bind(_.as_string())
  println(response)
}
